<%- include('layout') %>
    <style>
        .fruite-img {
            width: 100%;
            height: 180px;
            padding-bottom: 0px;
            overflow: hidden;
        }


        #search-icon-1 {
            cursor: pointer;
            /* Ensure the icon shows a pointer cursor */
        }

        .highlight {
            background-color: yellow;
            padding: 0 3px;
            border-radius: 2px;
        }


        .fruite-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fruite-item {
            text-align: center;
        }
    </style>
    <!-- Single Page Header start -->
    <div class="container-fluid page-header py-5">
        <h1 class="text-center text-white display-6">Shop</h1>
        <ol class="breadcrumb justify-content-center mb-0">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active text-white">Shop</li>
        </ol>
    </div>
    <!-- Single Page Header End -->


    <!-- Fruits Shop Start-->
    <div class="container-fluid fruite py-5">
        <div class="container py-5">
            <h1 class="mb-4">Fresh fruits shop</h1>
            <div class="row g-4">
                <div class="col-lg-12">
                    <div class="row g-4">
                        <div class="col-xl-3">
                            <div class="input-group w-100 mx-auto d-flex">
                                <input type="search" id="search-input" class="form-control p-3" placeholder="keywords">
                                <span id="search-icon-1" class="input-group-text p-3"><i
                                        class="fa fa-search"></i></span>
                            </div>
                        </div>
                        <div class="col-6"></div>
                        <div class="col-xl-3">
                            <div class="bg-light ps-3 py-3 rounded d-flex justify-content-between mb-4">
                                <label for="sorting">Sorting</label>
                                <select id="sorting" name="sorting" class="border-0 form-select-sm bg-light me-3">
                                    <option value="">None</option>
                                    <option value="popularity">Popularity</option>
                                    <option value="price_asc">Price: Low to High</option>
                                    <option value="price_desc">Price: High to Low</option>
                                    <option value="rating">Rating</option>
                                    <option value="newest">Newest Arrivals</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="col-lg-3">
                            <div class="row g-4">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <h4>Categories</h4>
                                        <ul class="list-unstyled fruite-categorie">
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <h4 class="mb-2">Price</h4>
                                        <input type="range" class="form-range w-100" id="rangeInput" name="rangeInput"
                                            min="0" max="500" value="0" oninput="updatePriceRange(this.value)">
                                        <output id="amount" name="amount" min-value="0" max-value="500"
                                            for="rangeInput">0</output>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <h4>Additional</h4>
                                        <div class="mb-2">
                                            <input type="radio" class="me-2" id="Categories-1" name="Categories-1"
                                                value="Beverages">
                                            <label for="Categories-1"> Organic</label>
                                        </div>
                                        <div class="mb-2">
                                            <input type="radio" class="me-2" id="Categories-2" name="Categories-1"
                                                value="Beverages">
                                            <label for="Categories-2"> Fresh</label>
                                        </div>
                                        <div class="mb-2">
                                            <input type="radio" class="me-2" id="Categories-3" name="Categories-1"
                                                value="Beverages">
                                            <label for="Categories-3"> Sales</label>
                                        </div>
                                        <div class="mb-2">
                                            <input type="radio" class="me-2" id="Categories-4" name="Categories-1"
                                                value="Beverages">
                                            <label for="Categories-4"> Discount</label>
                                        </div>
                                        <div class="mb-2">
                                            <input type="radio" class="me-2" id="Categories-5" name="Categories-1"
                                                value="Beverages">
                                            <label for="Categories-5"> Expired</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <h4 class="mb-3">Featured products</h4>
                                    <div class="d-flex align-items-center justify-content-start">
                                        <div class="rounded me-4" style="width: 100px; height: 100px;">
                                            <img src="img/featur-1.jpg" class="img-fluid rounded" alt="">
                                        </div>
                                        <div>
                                            <h6 class="mb-2">Big Banana</h6>
                                            <div class="d-flex mb-2">
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star"></i>
                                            </div>
                                            <div class="d-flex mb-2">
                                                <h5 class="fw-bold me-2">2.99 $</h5>
                                                <h5 class="text-danger text-decoration-line-through">4.11 $</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-start">
                                        <div class="rounded me-4" style="width: 100px; height: 100px;">
                                            <img src="img/featur-2.jpg" class="img-fluid rounded" alt="">
                                        </div>
                                        <div>
                                            <h6 class="mb-2">Big Banana</h6>
                                            <div class="d-flex mb-2">
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star"></i>
                                            </div>
                                            <div class="d-flex mb-2">
                                                <h5 class="fw-bold me-2">2.99 $</h5>
                                                <h5 class="text-danger text-decoration-line-through">4.11 $</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-start">
                                        <div class="rounded me-4" style="width: 100px; height: 100px;">
                                            <img src="img/featur-3.jpg" class="img-fluid rounded" alt="">
                                        </div>
                                        <div>
                                            <h6 class="mb-2">Big Banana</h6>
                                            <div class="d-flex mb-2">
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star text-secondary"></i>
                                                <i class="fa fa-star"></i>
                                            </div>
                                            <div class="d-flex mb-2">
                                                <h5 class="fw-bold me-2">2.99 $</h5>
                                                <h5 class="text-danger text-decoration-line-through">4.11 $</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center my-4">
                                        <a href="#"
                                            class="btn border border-secondary px-4 py-3 rounded-pill text-primary w-100">Vew
                                            More</a>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="position-relative">
                                        <img src="img/banner-fruits.jpg" class="img-fluid w-100 rounded" alt="">
                                        <div class="position-absolute"
                                            style="top: 50%; right: 10px; transform: translateY(-50%);">
                                            <h3 class="text-secondary fw-bold">Fresh <br> Fruits <br> Banner</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-9">
                            <div class="row g-4 justify-content-center" id="product-list">
                                <!-- Product items will be inserted here dynamically -->

                            </div>
                            <div class="pagination d-flex justify-content-center mt-5">
                                <a href="#" class="rounded">&laquo;</a>
                                <a href="#" class="active rounded">1</a>
                                <a href="#" class="rounded">2</a>
                                <a href="#" class="rounded">3</a>
                                <a href="#" class="rounded">4</a>
                                <a href="#" class="rounded">5</a>
                                <a href="#" class="rounded">6</a>
                                <a href="#" class="rounded">&raquo;</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Fruits Shop End-->


    <!-- Footer Start -->
    <%- include('footer') %>
        <script>
document.addEventListener('DOMContentLoaded', function () {
    fetchCategories(); // Fetch categories when the page loads
    updateCartItemCount(); // Update cart item count when the page loads

    // Fetch all products on page load
    fetchProducts(); // Call fetchProducts without parameters to show all products

    // Add event listener for search
    const searchInput = document.getElementById('search-input');
    const searchIcon = document.getElementById('search-icon-1');
    searchInput.addEventListener('input', function () {
        const query = searchInput.value.trim();
        fetchProducts(selectedCategoryId, '', '', query); // Pass the query to fetchProducts
    });

    searchIcon.addEventListener('click', function () {
        const query = searchInput.value.trim();
        if (query) {
            const url = `/search-results?search=${encodeURIComponent(query)}`;
            window.location.href = url;
        }
    });

    // Add event listener for sorting
    const sortingSelect = document.getElementById('sorting');
    sortingSelect.addEventListener('change', function () {
        const selectedOption = sortingSelect.value;
        fetchProducts(selectedCategoryId, selectedOption); // Pass the selected option to fetchProducts
    });

    // Add event listener for price range
    const rangeInput = document.getElementById('rangeInput');
    rangeInput.addEventListener('input', function () {
        updatePriceRange(rangeInput.value);
    });

    // Set initial active state
    setActiveCategory('');
});

let selectedCategoryId = ''; // Variable to store selected category ID

function updatePriceRange(value) {
    document.getElementById('amount').value = value;
    fetchProducts(selectedCategoryId, '', value); // Pass the price range to fetchProducts
}

async function fetchCategories() {
    try {
        const response = await fetch('/users/get-categories');
        const data = await response.json();
        const categories = data.categories;
        const totalProducts = data.totalProducts; // Get the total number of products
        const categoryList = document.querySelector('.fruite-categorie');
        categoryList.innerHTML = '';

        // Add All Products option
        const allProductsItem = `
            <li>
                <div class="d-flex justify-content-between fruite-name">
                    <a href="javascript:void(0);" onclick="selectCategory('')">
                        <i class="fas fa-list me-2"></i> All Products
                    </a>
                    <span>(${totalProducts})</span>
                </div>
            </li>
        `;
        categoryList.insertAdjacentHTML('beforeend', allProductsItem);

        // Add other categories
        categories.forEach(category => {
            const categoryItem = `
                <li>
                    <div class="d-flex justify-content-between fruite-name">
                        <a href="javascript:void(0);" onclick="selectCategory('${category._id}')">
                            <i class="fas fa-apple-alt me-2"></i>${category.name}
                        </a>
                        <span>(${category.product_count})</span>
                    </div>
                </li>
            `;
            categoryList.insertAdjacentHTML('beforeend', categoryItem);
        });
    } catch (err) {
        console.error('Error fetching categories:', err);
    }
}

async function fetchProducts(categoryId = '', sortBy = '', maxPrice = '', searchQuery = '') {
    try {
        let url = `/get-All-products`;
        const params = [];
        if (categoryId) {
            params.push(`id=${categoryId}`);
        }
        if (sortBy) {
            params.push(`sort=${sortBy}`);
        }
        if (maxPrice) {
            params.push(`maxPrice=${maxPrice}`);
        }
        if (searchQuery) {
            params.push(`search=${encodeURIComponent(searchQuery)}`); // Encode the search query
        }
        if (params.length > 0) {
            url += `?${params.join('&')}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch products');
        let { products, wishlist } = await response.json();
        products = products.filter(product => product.status === "approved");
        const productList = document.getElementById('product-list');
        productList.innerHTML = '';

        products.forEach(product => {
            const isInWishlist = wishlist && wishlist.includes(product._id); // Check if product is in wishlist
            const productItem = `
                <div class="col-md-6 col-lg-6 col-xl-4">
                    <div class="rounded position-relative fruite-item" data-product-id="${product.name}">
                        <div class="fruite-img position-relative">
                            <img src="images/${product.images[0]}" class="img-fluid w-100 rounded-top" alt="${product.name}">
                            <div class="position-absolute top-0 end-0 p-2">
                                <i class="fa fa-heart heart-icon ${isInWishlist ? 'filled' : ''}" 
                                   style="font-size: 18px; cursor: pointer;" 
                                   onclick="handleHeartClick(event, '${product._id}')"></i>
                            </div>
                        </div>
                        <div class="text-white bg-secondary px-3 py-1 rounded position-absolute" style="top: 10px; left: 10px;">
                            ${product.category.name}
                        </div>
                        <div class="p-4 border border-secondary border-top-0 rounded-bottom">
                            <h4>${highlightText(product.name, searchQuery)}</h4>
                            <p>${highlightText(product.description, searchQuery)}</p>
                            <div class="justify-content-between flex-lg-wrap" style="text-align:center">
                                <p class="text-dark fs-5 fw-bold mb-0">$${product.price} / kg</p>
                                <a href="#" class="btn border border-secondary rounded-pill px-3 text-primary add-to-cart-btn" data-product-id="${product._id}">
                                    <i class="fa fa-shopping-bag me-2 text-primary"></i> Add to cart
                                </a> 
                            </div>
                        </div>
                    </div>
                </div>
            `;
            productList.insertAdjacentHTML('beforeend', productItem);
        });

        // Attach event listeners to the "Add to cart" buttons
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                event.preventDefault();
                const productId = event.target.getAttribute('data-product-id');
                const quantity = 1; // Default quantity; you can modify this if you have an input field for quantity

                try {
                    const response = await fetch('/cart/add/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ productId, quantity })
                    });

                    const textResponse = await response.text(); // Read response as text
                    if (response.ok) {
                        try {
                            const result = JSON.parse(textResponse); // Attempt to parse JSON
                            alert(result.message);

                            // Update cart item count after adding product to cart
                            const newCartItemCountResponse = await fetch('/cart/item-count');
                            if (newCartItemCountResponse.ok) {
                                const newCartItemCount = await newCartItemCountResponse.json();
                                const cartItemCountElement = document.querySelector('.cart-item-count');
                                if (cartItemCountElement) {
                                    cartItemCountElement.textContent = newCartItemCount;
                                }
                            } else {
                                console.error('Failed to fetch updated cart item count');
                            }
                        } catch (error) {
                            window.location.href = '/login';
                            console.error(error);
                        }
                    } else if (response.status === 401) {
                        // Redirect to login page if user is not authenticated
                        window.location.href = '/login';
                    } else {
                        console.error('Failed to add product to cart', response.status);
                        alert('Failed to add product to cart');
                    }
                } catch (err) {
                    console.error('Error adding product to cart:', err);
                }
            });
        });
    } catch (err) {
        console.error('Error fetching products:', err);
    }
}

function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

async function updateCartItemCount() {
    try {
        const response = await fetch('/cart/item-count');
        if (!response.ok) throw new Error('Network response was not ok');
        const itemCount = await response.json();
        const cartItemCountElement = document.querySelector('.cart-item-count');
        if (cartItemCountElement) {
            cartItemCountElement.textContent = itemCount;
        }
    } catch (error) {
        console.error('Error fetching cart item count:', error);
    }
}

function selectCategory(categoryId) {
    selectedCategoryId = categoryId;

    // Reset the sorting option
    const sortingSelect = document.getElementById('sorting');
    sortingSelect.value = ''; // Reset to default value

    // Fetch products based on the selected category with reset sorting
    fetchProducts(categoryId, '', '', '');

    // Update the active state of the category
    setActiveCategory(categoryId);
}


function setActiveCategory(categoryId) {
    document.querySelectorAll('.fruite-categorie a').forEach(link => {
        const hrefCategoryId = link.getAttribute('onclick')?.match(/'([^']+)'/)?.[1] || '';
        if (hrefCategoryId === categoryId) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
}
        </script>
        <script src="/js/link.js"></script>
        <!-- JavaScript Libraries -->
        </body>

        </html>